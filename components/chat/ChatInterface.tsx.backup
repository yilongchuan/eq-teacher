'use client';

import { useState, useRef, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Avatar } from '@/components/ui/avatar';
import { cn } from '@/lib/utils';

interface Message {
  role: 'user' | 'assistant';
  content: string;
}

interface Scenario {
  id: string;
  title: string;
  domain: string;
  difficulty: number;
  character: {
    name: string;
    role: string;
    personality: string;
    avatar: string;
    background: string;
  };
  scenario_context: string;
  system_prompt: string;
  rubric: any[];
}

interface ChatInterfaceProps {
  scenarioId: string;
  sessionId?: string | null;
  onComplete?: () => void;
}

export function ChatInterface({ scenarioId, sessionId, onComplete }: ChatInterfaceProps) {
  const [messages, setMessages] = useState<Message[]>([]);
  const [input, setInput] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [currentSessionId, setCurrentSessionId] = useState<string | null>(sessionId || null);
  const [scenario, setScenario] = useState<Scenario | null>(null);
  const [isInitializing, setIsInitializing] = useState(true);
  const [currentTurn, setCurrentTurn] = useState(0);
  const [maxTurns] = useState(3);
  const [evaluation, setEvaluation] = useState<any>(null);
  const [isEvaluating, setIsEvaluating] = useState(false);
  const messagesEndRef = useRef<HTMLDivElement>(null);

  // è·å–åœºæ™¯ä¿¡æ¯å¹¶åˆå§‹åŒ–å¯¹è¯
  useEffect(() => {
    if (sessionId) {
      // åŠ è½½å·²æœ‰ä¼šè¯
      fetchSession(sessionId);
    } else if (scenarioId) {
      // æ–°åœºæ™¯ï¼Œè·å–åœºæ™¯ä¿¡æ¯å¹¶åˆå§‹åŒ–å¯¹è¯
      initializeScenario();
    }
  }, [sessionId, scenarioId]);

  const fetchSession = async (sessionId: string) => {
    try {
      setIsInitializing(true);
      const response = await fetch(`/api/sessions/${sessionId}`);
      if (!response.ok) throw new Error('Failed to fetch session');
      const sessionData = await response.json();
      
      setMessages(sessionData.messages || []);
      setCurrentTurn(sessionData.turn_count || 0);
      setCurrentSessionId(sessionId);
      
      // å¦‚æœä¼šè¯å·²å®Œæˆä¸”æœ‰è¯„åˆ†ä¿¡æ¯ï¼Œè®¾ç½®è¯„åˆ†
      if (sessionData.status === 'completed' && sessionData.overall_score) {
        setEvaluation({
          overall_score: sessionData.overall_score,
          objective_achievement_rate: sessionData.objective_achievement_rate,
          feedback: sessionData.feedback,
          improvement_suggestions: sessionData.improvement_suggestions
        });
      }
      
      // å°è¯•è·å–åœºæ™¯ä¿¡æ¯
      if (sessionData.scenario_id) {
        const scenarioResponse = await fetch(`/api/scenarios/${sessionData.scenario_id}`);
        if (scenarioResponse.ok) {
          const scenarioData = await scenarioResponse.json();
          setScenario(scenarioData);
        }
      }
    } catch (error) {
      console.error('Error fetching session:', error);
    } finally {
      setIsInitializing(false);
    }
  };

  const initializeScenario = async () => {
    try {
      setIsInitializing(true);
      console.log('Initializing scenario with ID:', scenarioId);
      
      // è·å–åœºæ™¯ä¿¡æ¯
      const response = await fetch(`/api/scenarios/${scenarioId}`);
      if (!response.ok) {
        console.error('Failed to fetch scenario, status:', response.status);
        throw new Error('Failed to fetch scenario');
      }
      
      const scenarioData = await response.json();
      console.log('Fetched scenario data:', scenarioData);
      
      if (!scenarioData || !scenarioData.system_prompt) {
        console.error('Invalid scenario data:', scenarioData);
        throw new Error('Invalid scenario data');
      }
      
      // å¦‚æœæ•°æ®åº“ä¸­æ²¡æœ‰è§’è‰²ä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤å€¼
      if (!scenarioData.character) {
        scenarioData.character = {
          name: getDefaultCharacterName(scenarioData.domain),
          role: getDefaultCharacterRole(scenarioData.domain),
          personality: 'å‹å¥½',
          avatar: getDefaultCharacterAvatar(scenarioData.domain),
          background: ''
        };
      }
      
      if (!scenarioData.scenario_context) {
        scenarioData.scenario_context = scenarioData.title;
      }
      
      setScenario(scenarioData);

      // AIä¸»åŠ¨å‘èµ·å¯¹è¯å¹¶åˆ›å»ºä¼šè¯
      const initialMessage = await generateInitialMessage(scenarioData);
      console.log('Generated initial message:', initialMessage);
      
      // åˆ›å»ºä¼šè¯
      const sessionResponse = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          scenarioId,
          message: 'å¼€å§‹å¯¹è¯', // ä½¿ç”¨ä¸€ä¸ªå ä½ç¬¦æ¶ˆæ¯
          isInitializing: true // æ ‡è®°è¿™æ˜¯åˆå§‹åŒ–è°ƒç”¨
        }),
      });

      if (!sessionResponse.ok) {
        throw new Error('Failed to create session');
      }

      const sessionData = await sessionResponse.json();
      setCurrentSessionId(sessionData.sessionId);
      
      // è®¾ç½®æ¶ˆæ¯ï¼šAIçš„å¼€åœºç™½
      setMessages([{ role: 'assistant', content: initialMessage }]);
      // AIçš„å¼€åœºç™½ä¸ç®—è½®æ¬¡ï¼Œä»0å¼€å§‹
      setCurrentTurn(0);
    } catch (error) {
      console.error('Error initializing scenario:', error);
      // å¦‚æœåˆå§‹åŒ–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ¶ˆæ¯
      if (scenarioId) {
        const defaultScenario = {
          id: scenarioId,
          title: 'æƒ…å•†å¯¹è¯ç»ƒä¹ ',
          domain: 'general',
          difficulty: 1,
          character: {
            name: 'AIåŠ©æ‰‹',
            role: 'å¯¹è¯ä¼™ä¼´',
            personality: 'å‹å¥½',
            avatar: 'ğŸ¤–',
            background: ''
          },
          scenario_context: 'è¿™æ˜¯ä¸€ä¸ªæƒ…å•†å¯¹è¯ç»ƒä¹ åœºæ™¯',
          system_prompt: 'ä½ æ˜¯ä¸€ä¸ªæƒ…å•†å¯¹è¯ç»ƒä¹ çš„AIåŠ©æ‰‹ã€‚',
          rubric: []
        };
        setScenario(defaultScenario);
        setMessages([{ role: 'assistant', content: 'ä½ å¥½ï¼æ¬¢è¿æ¥åˆ°æƒ…å•†å¯¹è¯ç»ƒä¹ ã€‚è®©æˆ‘ä»¬å¼€å§‹å§ï¼' }]);
      }
    } finally {
      setIsInitializing(false);
    }
  };

  const getDefaultCharacterName = (domain: string) => {
    const nameMap: { [key: string]: string } = {
      'family': 'å¦ˆå¦ˆ',
      'workplace': 'åŒäº‹',
      'friendship': 'æœ‹å‹',
      'romantic': 'æ‹äºº',
      'social': 'æ–°æœ‹å‹'
    };
    return nameMap[domain] || 'AIåŠ©æ‰‹';
  };

  const getDefaultCharacterRole = (domain: string) => {
    const roleMap: { [key: string]: string } = {
      'family': 'å®¶åº­æˆå‘˜',
      'workplace': 'å·¥ä½œä¼™ä¼´',
      'friendship': 'å¥½æœ‹å‹',
      'romantic': 'æ‹çˆ±å¯¹è±¡',
      'social': 'ç¤¾äº¤ä¼™ä¼´'
    };
    return roleMap[domain] || 'å¯¹è¯ä¼™ä¼´';
  };

  const getDefaultCharacterAvatar = (domain: string) => {
    const avatarMap: { [key: string]: string } = {
      'family': 'ğŸ‘©â€ğŸ‘§â€ğŸ‘¦',
      'workplace': 'ğŸ‘¨â€ğŸ’¼',
      'friendship': 'ğŸ‘¥',
      'romantic': 'ğŸ’•',
      'social': 'ğŸ‰'
    };
    return avatarMap[domain] || 'ğŸ¤–';
  };

  const generateInitialMessage = async (scenarioData: Scenario) => {
    try {
      const response = await fetch('/api/generate-initial-message', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ scenario: scenarioData }),
      });
      if (!response.ok) throw new Error('Failed to generate initial message');
      const data = await response.json();
      return data.message;
    } catch (error) {
      console.error('Error generating initial message:', error);
      // å›é€€åˆ°é»˜è®¤æ¶ˆæ¯
      return getDefaultInitialMessage(scenarioData);
    }
  };

  const getDefaultInitialMessage = (scenarioData: Scenario) => {
    // æ ¹æ®åœºæ™¯ç±»å‹ç”Ÿæˆé»˜è®¤çš„å¼€åœºç™½
    switch (scenarioData.domain) {
      case 'family':
        return "å¤§å®¶å¥½ï¼ä»Šå¤©çš„æ™šé¤çœŸä¸°ç››å‘¢ã€‚æˆ‘æƒ³æˆ‘ä»¬å¯ä»¥èŠèŠæœ€è¿‘éƒ½åœ¨å¿™ä»€ä¹ˆï¼Œåˆ†äº«ä¸€ä¸‹å½¼æ­¤çš„ç”Ÿæ´»ã€‚å¦ˆå¦ˆï¼Œæ‚¨ä»Šå¤©å·¥ä½œæ€ä¹ˆæ ·ï¼Ÿ";
      case 'workplace':
        return "ä½ å¥½ï¼å¾ˆé«˜å…´è§åˆ°ä½ ã€‚æˆ‘æƒ³æˆ‘ä»¬å¯ä»¥å¼€å§‹ä»Šå¤©çš„è®¨è®ºäº†ã€‚å…³äºè¿™ä¸ªé¡¹ç›®ï¼Œä½ æœ‰ä»€ä¹ˆæƒ³æ³•å—ï¼Ÿ";
      case 'friendship':
        return "å—¨ï¼å¥½ä¹…ä¸è§äº†ï¼æœ€è¿‘è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿæˆ‘ä»¬æ‰¾ä¸ªåœ°æ–¹åä¸‹æ¥å¥½å¥½èŠèŠå§ã€‚";
      case 'romantic':
        return "ä½ å¥½ï¼Œå¾ˆé«˜å…´èƒ½å’Œä½ åœ¨è¿™é‡Œè§é¢ã€‚è¿™ä¸ªåœ°æ–¹çœŸä¸é”™ï¼Œä½ è§‰å¾—å‘¢ï¼Ÿ";
      case 'social':
        return "ä½ å¥½ï¼æˆ‘æ³¨æ„åˆ°ä½ ä¹Ÿåœ¨è¿™é‡Œï¼Œä»‹æ„æˆ‘è¿‡æ¥å’Œä½ èŠèŠå—ï¼Ÿ";
      default:
        return "ä½ å¥½ï¼å¾ˆé«˜å…´è®¤è¯†ä½ ã€‚æˆ‘ä»¬å¼€å§‹å¯¹è¯å§ï¼";
    }
  };

  const getDomainName = (domain: string) => {
    const domainMap: { [key: string]: string } = {
      'workplace': 'èŒåœºæ²Ÿé€š',
      'family': 'å®¶åº­å…³ç³»',
      'friendship': 'æœ‹å‹äº¤å¾€',
      'romantic': 'æ‹çˆ±å…³ç³»',
      'social': 'ç¤¾äº¤åœºåˆ'
    };
    return domainMap[domain] || domain;
  };

  const getDifficultyName = (difficulty: number) => {
    const difficultyMap: { [key: number]: string } = {
      1: 'åˆçº§',
      2: 'ä¸­çº§',
      3: 'é«˜çº§'
    };
    return difficultyMap[difficulty] || 'æœªçŸ¥';
  };

  const getCharacterInfo = (scenario: Scenario | null) => {
    // ä½¿ç”¨åœºæ™¯ä¸­çš„åŠ¨æ€è§’è‰²ä¿¡æ¯
    if (scenario && scenario.character) {
      return {
        name: scenario.character.name,
        avatar: scenario.character.avatar,
        role: scenario.character.role
      };
    }
    
    // å›é€€åˆ°é»˜è®¤å€¼
    return { name: 'AIåŠ©æ‰‹', avatar: 'ğŸ¤–', role: 'å¯¹è¯ä¼™ä¼´' };
  };

  const evaluateSession = async (sessionId: string) => {
    try {
      setIsEvaluating(true);
      const response = await fetch('/api/eval', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sessionId }),
      });

      if (!response.ok) {
        throw new Error('Failed to evaluate session');
      }

      const data = await response.json();
      setEvaluation(data.evaluation);
    } catch (error) {
      console.error('Error evaluating session:', error);
      // æ˜¾ç¤ºè¯„åˆ†å¤±è´¥çš„æ¶ˆæ¯
      setEvaluation({
        overall_score: 75,
        feedback: 'è¯„åˆ†ç³»ç»Ÿæš‚æ—¶ä¸å¯ç”¨ï¼Œä½†æ‚¨å·²ç»å®Œæˆäº†3è½®æƒ…å•†è®­ç»ƒï¼',
        improvement_suggestions: ['ç»§ç»­ç»ƒä¹ æ²Ÿé€šæŠ€å·§', 'å¤šè§‚å¯Ÿå¯¹æ–¹çš„æƒ…ç»ªååº”', 'ä¿æŒè€å¿ƒå’ŒåŒç†å¿ƒ']
      });
    } finally {
      setIsEvaluating(false);
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!input.trim() || isLoading) return;

    const userMessage = input.trim();
    setInput('');
    setIsLoading(true);

    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
    setMessages(prev => [...prev, { role: 'user', content: userMessage }]);

    try {
      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          sessionId: currentSessionId,
          message: userMessage,
          scenarioId: !currentSessionId ? scenarioId : undefined,
        }),
      });

      if (!response.ok) {
        throw new Error('Failed to send message');
      }

      const data = await response.json();
      
      // æ›´æ–°ä¼šè¯IDï¼ˆå¦‚æœæ˜¯æ–°ä¼šè¯ï¼‰
      if (data.sessionId && !currentSessionId) {
        setCurrentSessionId(data.sessionId);
      }

      // æ·»åŠ AIå›å¤åˆ°ç•Œé¢
      setMessages(prev => [...prev, { role: 'assistant', content: data.reply }]);
      
      // æ›´æ–°è½®æ¬¡ä¿¡æ¯
      const newTurn = data.turn || currentTurn + 1;
      setCurrentTurn(newTurn);
      
      // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æœ€å¤§è½®æ¬¡
      if (newTurn >= maxTurns && data.sessionId) {
        // 3è½®å¯¹è¯ç»“æŸï¼Œå¼€å§‹è¯„åˆ†
        setTimeout(() => {
          evaluateSession(data.sessionId || currentSessionId!);
        }, 1000); // 1ç§’åå¼€å§‹è¯„åˆ†
      }
    } catch (error) {
      console.error('Error sending message:', error);
      // ç§»é™¤ç”¨æˆ·æ¶ˆæ¯ï¼ˆå› ä¸ºå‘é€å¤±è´¥ï¼‰
      setMessages(prev => prev.slice(0, -1));
    } finally {
      setIsLoading(false);
    }
  };

  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages, evaluation, isEvaluating]);

  return (
    <div className="flex flex-col h-full overflow-hidden">
      {/* åœºæ™¯ä¿¡æ¯åŒºåŸŸ */}
      {scenario && (
        <div className="bg-gradient-to-r from-blue-50 to-purple-50 border-b border-gray-200 px-4 py-3 flex-shrink-0">
          <div className="flex items-center justify-between">
            <div className="flex items-center space-x-3">
              <div className="text-2xl">{getCharacterInfo(scenario).avatar}</div>
              <div>
                <h3 className="font-medium text-gray-900">{scenario.title}</h3>
                <div className="flex items-center space-x-4 text-xs text-gray-600 mt-1">
                  <span className="bg-blue-100 text-blue-800 px-2 py-1 rounded-full">
                    {getDomainName(scenario.domain)}
                  </span>
                  <span className="bg-green-100 text-green-800 px-2 py-1 rounded-full">
                    {getDifficultyName(scenario.difficulty)}
                  </span>
                  <span className="text-gray-500">
                    è§’è‰²ï¼š{getCharacterInfo(scenario).name} ({getCharacterInfo(scenario).role})
                  </span>
                </div>
              </div>
            </div>
            <div className="text-right">
              <div className="text-sm font-medium text-gray-700">
                ç¬¬ {Math.min(currentTurn, maxTurns)} / {maxTurns} è½®
              </div>
              <div className="text-xs text-gray-500">
                æƒ…å•†è®­ç»ƒå¯¹è¯
              </div>
            </div>
          </div>
        </div>
      )}

      {/* èŠå¤©æ¶ˆæ¯åŒºåŸŸ - åŒ…å«æ‰€æœ‰å†…å®¹çš„ç»Ÿä¸€æ»šåŠ¨åŒºåŸŸï¼Œå¼ºåˆ¶æ»šåŠ¨ */}
      <div 
        className="flex-1 p-4 space-y-4" 
        style={{ 
          overflowY: 'auto', 
          overflowX: 'hidden',
          height: '100%',
          minHeight: 0,
          maxHeight: '100%'
        }}
      >
        {/* åœºæ™¯èƒŒæ™¯è¯´æ˜ */}
        {scenario && (
          <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
            <div className="flex items-start space-x-3">
              <div className="text-2xl">ğŸ“‹</div>
              <div>
                <h4 className="font-medium text-blue-900 mb-2">åœºæ™¯èƒŒæ™¯</h4>
                <p className="text-sm text-blue-800 mb-3">
                  {scenario.scenario_context || `è¿™æ˜¯ä¸€ä¸ª${getDomainName(scenario.domain)}çš„æƒ…å•†è®­ç»ƒåœºæ™¯ã€‚æ‚¨å°†ä¸${getCharacterInfo(scenario).name}è¿›è¡Œå¯¹è¯ï¼Œç»ƒä¹ æ‚¨çš„æ²Ÿé€šæŠ€å·§ã€‚`}
                </p>
                <div className="text-xs text-blue-600">
                  ğŸ’¡ æç¤ºï¼šè¿ç”¨æƒ…å•†æŠ€å·§ï¼Œæ³¨æ„å¯¹æ–¹çš„æƒ…ç»ªå’Œéœ€æ±‚ï¼Œæ‰¾åˆ°æœ€ä½³çš„æ²Ÿé€šæ–¹å¼ã€‚
                </div>
              </div>
            </div>
          </div>
        )}
        
        {isInitializing ? (
          <div className="text-center py-8">
            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-4"></div>
            <p className="text-gray-600">æ­£åœ¨å‡†å¤‡æƒ…å•†è®­ç»ƒåœºæ™¯...</p>
          </div>
        ) : (
          <>
            {/* èŠå¤©æ¶ˆæ¯ */}
            {messages.map((message, index) => (
              <MessageBubble key={index} message={message} isUser={message.role === 'user'} />
            ))}
            
            {/* è¯„åˆ†ç»“æœåŒºåŸŸ - ä½œä¸ºå¯¹è¯çš„æœ€åéƒ¨åˆ†æ˜¾ç¤º */}
            {evaluation && (
              <div className="space-y-4 mt-6">
                <div className="text-center py-6 bg-green-50 rounded-lg border border-green-200">
                  <div className="text-3xl mb-3">ğŸ‰</div>
                  <div className="text-xl font-medium text-green-600 mb-3">
                    æƒ…å•†è®­ç»ƒå®Œæˆï¼
                  </div>
                  <div className="text-4xl font-bold text-green-700 mb-3">
                    {evaluation.overall_score}/100
                  </div>
                  <div className="text-sm text-gray-600 mb-3">
                    ç»¼åˆæƒ…å•†è¯„åˆ†
                  </div>
                  {evaluation.objective_achievement_rate !== undefined && evaluation.objective_achievement_rate !== evaluation.overall_score && (
                    <div className="text-sm text-blue-600 bg-blue-100 px-3 py-1 rounded-full inline-block">
                      æ²Ÿé€šç›®æ ‡è¾¾æˆç‡: {evaluation.objective_achievement_rate}%
                    </div>
                  )}
                </div>
                
                <div className="bg-blue-50 rounded-lg p-6 border border-blue-200">
                  <h4 className="font-medium text-blue-900 mb-3 text-lg">ğŸ’¡ åé¦ˆè¯„ä»·</h4>
                  <p className="text-sm text-blue-800 mb-4 leading-relaxed">{evaluation.feedback}</p>
                  
                  {evaluation.improvement_suggestions && evaluation.improvement_suggestions.length > 0 && (
                    <div className="mt-5">
                      <h5 className="font-medium text-blue-900 mb-4 text-lg">ğŸ¯ æ”¹è¿›å»ºè®®</h5>
                      <div className="text-sm text-blue-800 space-y-4">
                        {evaluation.improvement_suggestions.map((suggestion: string, index: number) => (
                          <div key={index} className="flex items-start leading-relaxed">
                            <span className="mr-3 mt-2 flex-shrink-0 w-2 h-2 bg-blue-600 rounded-full"></span>
                            <span className="flex-1">{suggestion}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
                
                <div className="flex space-x-3 pt-4">
                  <button
                    onClick={() => window.location.reload()}
                    className="flex-1 px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-medium"
                  >
                    å†æ¬¡è®­ç»ƒ
                  </button>
                  <button
                    onClick={() => onComplete && onComplete()}
                    className="flex-1 px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-medium"
                  >
                    æŸ¥çœ‹å†å²
                  </button>
                </div>
              </div>
            )}

            {/* è¯„ä¼°ä¸­çŠ¶æ€ */}
            {isEvaluating && (
              <div className="text-center py-8 bg-yellow-50 rounded-lg border border-yellow-200 mt-6">
                <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500 mx-auto mb-4"></div>
                <div className="text-lg font-medium text-blue-600 mb-2">
                  æ­£åœ¨è¯„ä¼°æ‚¨çš„è¡¨ç°...
                </div>
                <div className="text-sm text-gray-600">
                  AIæ­£åœ¨åˆ†ææ‚¨çš„æ²Ÿé€šæŠ€å·§å’Œæƒ…å•†è¡¨ç°
                </div>
              </div>
            )}

            {/* è®­ç»ƒå®Œæˆç­‰å¾…è¯„åˆ†çŠ¶æ€ */}
            {currentTurn >= maxTurns && !evaluation && !isEvaluating && (
              <div className="text-center py-8 bg-green-50 rounded-lg border border-green-200 mt-6">
                <div className="text-2xl mb-3">âœ…</div>
                <div className="text-lg font-medium text-green-600 mb-2">
                  ğŸ‰ æƒ…å•†è®­ç»ƒå®Œæˆï¼
                </div>
                <div className="text-sm text-gray-600">
                  æ‚¨å·²å®Œæˆ {maxTurns} è½®å¯¹è¯è®­ç»ƒï¼Œç³»ç»Ÿæ­£åœ¨ä¸ºæ‚¨ç”Ÿæˆè¯„åˆ†å’Œå»ºè®®...
                </div>
              </div>
            )}
          </>
        )}
              <div className="space-y-4 mt-6">
                <div className="text-center py-6 bg-green-50 rounded-lg border border-green-200">
                  <div className="text-3xl mb-3">ğŸ‰</div>
                  <div className="text-xl font-medium text-green-600 mb-3">
                    æƒ…å•†è®­ç»ƒå®Œæˆï¼
                  </div>
                  <div className="text-4xl font-bold text-green-700 mb-3">
                    {evaluation.overall_score}/100
                  </div>
                  <div className="text-sm text-gray-600 mb-3">
                    ç»¼åˆæƒ…å•†è¯„åˆ†
                  </div>
                  {evaluation.objective_achievement_rate !== undefined && evaluation.objective_achievement_rate !== evaluation.overall_score && (
                    <div className="text-sm text-blue-600 bg-blue-100 px-3 py-1 rounded-full inline-block">
                      æ²Ÿé€šç›®æ ‡è¾¾æˆç‡: {evaluation.objective_achievement_rate}%
                    </div>
                  )}
                </div>
                
                <div className="bg-blue-50 rounded-lg p-6 border border-blue-200">
                  <h4 className="font-medium text-blue-900 mb-3 text-lg">ğŸ’¡ åé¦ˆè¯„ä»·</h4>
                  <p className="text-sm text-blue-800 mb-4 leading-relaxed">{evaluation.feedback}</p>
                  
                  {evaluation.improvement_suggestions && evaluation.improvement_suggestions.length > 0 && (
                    <div className="mt-5">
                      <h5 className="font-medium text-blue-900 mb-4 text-lg">ğŸ¯ æ”¹è¿›å»ºè®®</h5>
                      <div className="text-sm text-blue-800 space-y-4">
                        {evaluation.improvement_suggestions.map((suggestion: string, index: number) => (
                          <div key={index} className="flex items-start leading-relaxed">
                            <span className="mr-3 mt-2 flex-shrink-0 w-2 h-2 bg-blue-600 rounded-full"></span>
                            <span className="flex-1">{suggestion}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
                
                <div className="flex space-x-3 pt-4">
                  <button
                    onClick={() => window.location.reload()}
                    className="flex-1 px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-medium"
                  >
                    å†æ¬¡è®­ç»ƒ
                  </button>
                  <button
                    onClick={() => onComplete && onComplete()}
                    className="flex-1 px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-medium"
                  >
                    æŸ¥çœ‹å†å²
                  </button>
                </div>
              </div>
            )}

            {/* è¯„ä¼°ä¸­çŠ¶æ€ */}
            {isEvaluating && (
              <div className="text-center py-8 bg-yellow-50 rounded-lg border border-yellow-200 mt-6">
                <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500 mx-auto mb-4"></div>
                <div className="text-lg font-medium text-blue-600 mb-2">
                  æ­£åœ¨è¯„ä¼°æ‚¨çš„è¡¨ç°...
                </div>
                <div className="text-sm text-gray-600">
                  AIæ­£åœ¨åˆ†ææ‚¨çš„æ²Ÿé€šæŠ€å·§å’Œæƒ…å•†è¡¨ç°
                </div>
              </div>
            )}

            {/* è®­ç»ƒå®Œæˆç­‰å¾…è¯„åˆ†çŠ¶æ€ */}
            {currentTurn >= maxTurns && !evaluation && !isEvaluating && (
              <div className="text-center py-8 bg-green-50 rounded-lg border border-green-200 mt-6">
                <div className="text-2xl mb-3">âœ…</div>
                <div className="text-lg font-medium text-green-600 mb-2">
                  ğŸ‰ æƒ…å•†è®­ç»ƒå®Œæˆï¼
                </div>
                <div className="text-sm text-gray-600">
                  æ‚¨å·²å®Œæˆ {maxTurns} è½®å¯¹è¯è®­ç»ƒï¼Œç³»ç»Ÿæ­£åœ¨ä¸ºæ‚¨ç”Ÿæˆè¯„åˆ†å’Œå»ºè®®...
                </div>
              </div>
            )}
          </>
        )}
          <div className="space-y-4 mt-6">
            <div className="text-center py-6 bg-green-50 rounded-lg border border-green-200">
              <div className="text-3xl mb-3">ğŸ‰</div>
              <div className="text-xl font-medium text-green-600 mb-3">
                æƒ…å•†è®­ç»ƒå®Œæˆï¼
              </div>
              <div className="text-4xl font-bold text-green-700 mb-3">
                {evaluation.overall_score}/100
              </div>
              <div className="text-sm text-gray-600 mb-3">
                ç»¼åˆæƒ…å•†è¯„åˆ†
              </div>
              {evaluation.objective_achievement_rate !== undefined && evaluation.objective_achievement_rate !== evaluation.overall_score && (
                <div className="text-sm text-blue-600 bg-blue-100 px-3 py-1 rounded-full inline-block">
                  æ²Ÿé€šç›®æ ‡è¾¾æˆç‡: {evaluation.objective_achievement_rate}%
                </div>
              )}
            </div>
            
            <div className="bg-blue-50 rounded-lg p-6 border border-blue-200">
              <h4 className="font-medium text-blue-900 mb-3 text-lg">ğŸ’¡ åé¦ˆè¯„ä»·</h4>
              <p className="text-sm text-blue-800 mb-4 leading-relaxed">{evaluation.feedback}</p>
              
              {evaluation.improvement_suggestions && evaluation.improvement_suggestions.length > 0 && (
                <div className="mt-5">
                  <h5 className="font-medium text-blue-900 mb-4 text-lg">ğŸ¯ æ”¹è¿›å»ºè®®</h5>
                  <div className="text-sm text-blue-800 space-y-4">
                    {evaluation.improvement_suggestions.map((suggestion: string, index: number) => (
                      <div key={index} className="flex items-start leading-relaxed">
                        <span className="mr-3 mt-2 flex-shrink-0 w-2 h-2 bg-blue-600 rounded-full"></span>
                        <span className="flex-1">{suggestion}</span>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
            
            <div className="flex space-x-3 pt-4">
              <button
                onClick={() => window.location.reload()}
                className="flex-1 px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-medium"
              >
                å†æ¬¡è®­ç»ƒ
              </button>
              <button
                onClick={() => onComplete && onComplete()}
                className="flex-1 px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-medium"
              >
                æŸ¥çœ‹å†å²
              </button>
            </div>
          </div>
        )}

        {/* è¯„ä¼°ä¸­çŠ¶æ€ */}
        {isEvaluating && (
          <div className="text-center py-8 bg-yellow-50 rounded-lg border border-yellow-200 mt-6">
            <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500 mx-auto mb-4"></div>
            <div className="text-lg font-medium text-blue-600 mb-2">
              æ­£åœ¨è¯„ä¼°æ‚¨çš„è¡¨ç°...
            </div>
            <div className="text-sm text-gray-600">
              AIæ­£åœ¨åˆ†ææ‚¨çš„æ²Ÿé€šæŠ€å·§å’Œæƒ…å•†è¡¨ç°
            </div>
          </div>
        )}

        {/* è®­ç»ƒå®Œæˆç­‰å¾…è¯„åˆ†çŠ¶æ€ */}
        {currentTurn >= maxTurns && !evaluation && !isEvaluating && (
          <div className="text-center py-8 bg-green-50 rounded-lg border border-green-200 mt-6">
            <div className="text-2xl mb-3">âœ…</div>
            <div className="text-lg font-medium text-green-600 mb-2">
              ğŸ‰ æƒ…å•†è®­ç»ƒå®Œæˆï¼
            </div>
            <div className="text-sm text-gray-600">
              æ‚¨å·²å®Œæˆ {maxTurns} è½®å¯¹è¯è®­ç»ƒï¼Œç³»ç»Ÿæ­£åœ¨ä¸ºæ‚¨ç”Ÿæˆè¯„åˆ†å’Œå»ºè®®...
            </div>
          </div>
        )}

        <div ref={messagesEndRef} />
        {/* åº•éƒ¨å®‰å…¨é—´è· - ç¡®ä¿å†…å®¹ä¸è¢«é®æŒ¡ï¼Œç‰¹åˆ«æ˜¯è¯„ä»·åé¦ˆåŒºåŸŸ */}
        <div className="h-40"></div>
      </div>

      {/* è¾“å…¥åŒºåŸŸ - ä»…ç”¨äºè¾“å…¥ */}
      {!evaluation && !isEvaluating && currentTurn < maxTurns && (
        <div className="border-t border-gray-200 p-4 flex-shrink-0 bg-white">
          <form onSubmit={handleSubmit} className="flex space-x-2">
            <input
              type="text"
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={isLoading ? "AIæ­£åœ¨æ€è€ƒ..." : "è¾“å…¥æ‚¨çš„å›å¤..."}
              disabled={isLoading}
              className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100"
            />
            <button
              type="submit"
              disabled={isLoading || !input.trim()}
              className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {isLoading ? 'å‘é€ä¸­...' : 'å‘é€'}
            </button>
          </form>
        </div>
      )}
    </div>
  );
}

interface MessageBubbleProps {
  message: Message;
  isUser: boolean;
}

function MessageBubble({ message, isUser }: MessageBubbleProps) {
  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      className={cn(
        "flex items-start space-x-2",
        isUser ? "flex-row-reverse space-x-reverse" : ""
      )}
    >
      <div
        className={cn(
          "w-8 h-8 rounded-full flex items-center justify-center",
          isUser 
            ? "bg-gradient-to-r from-blue-500 to-purple-600" 
            : "bg-gradient-to-r from-green-400 to-blue-500"
        )}
      >
        <span className="text-white text-xs font-medium">
          {isUser ? "æˆ‘" : "AI"}
        </span>
      </div>
      <div
        className={cn(
          "max-w-[70%] rounded-lg px-4 py-2",
          isUser
            ? "bg-blue-500 text-white rounded-tr-none"
            : "bg-white text-gray-800 rounded-tl-none shadow"
        )}
      >
        <p className="text-sm">{message.content}</p>
      </div>
    </motion.div>
  );
} 